require "fileutils"
include FileUtils

%w[unit functional integration performance].each do |type|
  desc "run #{type} tests"
  task type do
    Dir.glob "./test/#{type}/*_test.rb" do |f|
      require f
    end
  end
end

desc "run all tests"
task :test do
  Dir.glob "./test/{unit,functional}/*_test.rb" do |f|
    require f
  end
end

desc "compile css and js"
task :asset do
  require "./script/asset"
  Asset.new(true).compile
end

def stat_files fs
  c = 0
  fc = 0
  total_size = 0.0
  fs.each do |f|
    fc += 1
    data = File.binread f
    c += data.count "\n"
    total_size += data.bytesize
  end
  puts "files: #{fc}"
  puts "lines: #{c}"
  puts "chars per line: #{total_size / c}"
end

desc "project statistics"
task :stat do
  puts "All:"
  stat_files Dir.glob '**/*.{rb,sass,slim,coffee}'

  puts "\nRuby:"
  stat_files Dir.glob('**/*.rb') - Dir.glob('test/**/*.rb')
end

desc "check project for common errors"
task :audit do
  ENV['RACK_ENV'] = 'audit'
  require "./config/boot"
  require "./script/audit_helpers"
end

desc "show all routes"
task :routes do
  ENV['RACK_ENV'] = 'audit'
  require "./config/boot"
  blue = -> s { "\e[36m#{s}\e[0m" }
  grey = -> s { "\e[37m#{s}\e[0m" }
  Sinatra::Application.routes.each do |verb, routes|
    puts blue[verb]
    puts routes.map{|(pattern, captures)| "#{pattern.source.ljust 45} #{grey[captures.join ', ']}"}
    puts
  end
end
